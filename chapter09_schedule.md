# 第9章　Scrapyの定期実行

## はじめに

ここではScrapyで作ったクローラーを定期的に実行する方法として、cronの設定やScrapingHubの使い方をまとめておきます。

### cronについて

cronはUNIX系のシステムに常駐するデーモンプログラムの1つ。デーモンとは、メインメモリ上に常駐して機能を提供するバックグラウンドプロセスの一種で、あらかじめ指定した時間に処理を実行したりするもの、とのこと。

cronの設定は下記のコマンドから行うが、jobがない場合、このように行う。

```text
$ crontab -l
crontab: no crontab for <user name>
```

そのため、初めてcronを利用する場合は`-e`で実行する。標準環境ではviが起動するので、\[i\]でインサートモードに変更して記入していく。曜日は日曜日の0始まり。

```text
$ crontab -e
```

jobの指定方法は、左から「分 時 日 月 曜日 コマンド」となる。下記の設定であれば、23時45分、日、月、曜日はなんでも良いということになるので、毎日23時45分に下記のhello.pyが実行されることになります。ログファイルが必要なければ、`>>`は不要。cronのjobの登録方法は他にもあるみたい。

```text
45 23 * * * [Python3のパス] [実行ファイルのパス] >> [実行結果やエラーログのパス] 2>&1
```

python3のフルパスは`which python3`で見つかります。

```text
$ which python3
/Library/Frameworks/Python.framework/Versions/3.8/bin/python3

# hello.pyの中身
import sys
import datetime
print('Python:' + sys.version)
print(datetime.datetime.now())
```

`>>`はリダイレクトという機能と関わってきます。ターミンるに出力される「標準出力」をファイルへ出力することをリダイレクトといいます。要するに、「画面出力された文字をファイルに保存する」と考えればわかりやすいのかもしれません。組み合わ次第でいろんな事ができるので下記にまとめておきます。

| 形式 | 内容 |
| :--- | :--- |
| コマンド &gt; ファイル | コマンドの結果をファイルへ書き込む |
| コマンド &lt; ファイル | ファイルの中身をコマンドの標準入力へ |
| コマンド &gt;&gt; ファイル | コマンドの出力結果をファイルへ追加 |
| コマンド 2&gt; ファイル | エラー出力をファイルへ書き込む |
| コマンド 2&gt;&gt; ファイル | ファイルにエラー出力を追加 |
| コマンド &gt; ファイル 2&gt;&1 | ファイルに標準出力と標準エラー出力を書き込む |
| コマンド &gt;&gt; ファイル 2&gt;&1 | ファイルに標準出力と標準エラー出力を追加 |

下記のjob\(1分ごとに実行\)であれば、数分後にはログファイル内に追記しているので、こうなります。

```text
$ crontab -l
*/1 * * * * /Library/Frameworks/Python.framework/Versions/3.8/bin/python3 /Users/aki/Desktop/hello.py >> /Users/aki/Desktop/exec-error.log 2>&1

Python:3.8.2 (v3.8.2:7b3ab5921f, Feb 24 2020, 17:52:18) 
[Clang 6.0 (clang-600.0.57)]
2020-06-02 00:55:00.739637
Python:3.8.2 (v3.8.2:7b3ab5921f, Feb 24 2020, 17:52:18) 
[Clang 6.0 (clang-600.0.57)]
2020-06-02 00:56:00.862855
Python:3.8.2 (v3.8.2:7b3ab5921f, Feb 24 2020, 17:52:18) 
[Clang 6.0 (clang-600.0.57)]
2020-06-02 00:57:00.985099
```

他にもいろんな指定ができるので、下記の通りまとめておきます。

```text
# 毎時10分にプログラムを実行する
10 * * * * python 

# 毎日6時にプログラムを実行する
0 6 * * * python 

# 25日の12時00分にプログラムを実行する
0 12 25 * * python 

# 9月26日の24時にプログラムを実行する
0 24 36 9 * python

# 日曜日の13時00分にプログラムを実行する
0 13 * * 0 python
 
# 1分毎にプログラムを実行する
*/1 * * * * python 
  
# 毎月20日10:00にプログラムを実行する
0 10 20 * * python 
  
# 毎週月曜日10:00にプログラムを実行する
0 10 * * 1 python

# 10分と20分と30分にプログラムを実行する
10,20,30 * * * * python
 
# 15日から20日の間、13時にプログラムを実行する
0 13 15-20 * * python
 
# 1,5,10,15~20日の間、13時にプログラムを実行する
0 13 1,5,10,15-20 * * python
 
# １時間毎にプログラムを実行する
* */1 * * * python
```

また、特に設定しない限り`/var/mail/user name`にログが残り続けるので、書きを書き込んでおきます。

```text
MAILTO=""
```

